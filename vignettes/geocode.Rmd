---
title: "Geocoding"
vignette: >
  %\VignetteIndexEntry{pkgdown}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6, 
  fig.height = 4,
  warning = F
)

devtools::load_all()
library(leaflet)
library(dismo)

col  = '#1c26a9'
col1 = '#212f3f'

icon.g <- awesomeIcons(
    icon='home',
    iconColor = col1,
    markerColor = "gray",
    library='fa')

icon.r <- awesomeIcons(
    icon='home',
    iconColor = col1,
    markerColor = 138,
    library='fa')

icon.b <- awesomeIcons(
    icon='home',
    iconColor = col1,
    markerColor = "blue",
    library='fa')

```


Users often need information regarding a location that they either know the lat/lon or place name of. For these cases, `AOI` offers a forward and reverse geocoding interface to the OpenStreetMap and ESRI APIs -neither of which require a registared API key! Moreover AOI provides a wikipedia geocoding sevice to try and geo-locate events that are generally not present in a typical gazzetter such as "I have a Dream Speech", "Thomas Fire", or "NOAA".

While other packages offer(ed) geocoding capabilities (dismo, prettymapr, ggmap, opencage) they are generally tied to the google API and/or require a user key. In mid 2018 the google maps API changed to a pay-for-play model meaning calls making those function no longer workable, for example the previously great dismo package:

```{r}
dismo::geocode("UCSB")
```

This page walks through some of the functionalites within the `geocode` and `revgeocode` functions.   

##*Geocoding*:

Geocoding converts placenames to latitude and longitude sets. `AOI` offers a geocoding function wrapping the [OpenStreetMaps Nominatim](https://wiki.openstreetmap.org/wiki/Nominatim) API. Here we use AOI's geocode to find the lat/lon set for the Grand Canyon, using both the colloquial name, and the (lat/long) pair returned from a quick google search <a target="_blank"href="http://www.Google.com/search?q=grand+canyon+lat+long">Google search.</a> Notice slightly different locations are generated:

```{r, message = F}
GC_osm = geocode("grand canyon")
```

```{r, echo = FALSE}

latlon = "<strong>Query by Lat Long</strong>"
API = "<strong>Geocode by Name</strong>"

leaflet(option=leafletOptions(zoomControl= FALSE, minZoom = 10, maxZoom = 10)) %>% addProviderTiles(providers$CartoDB.Positron) %>% 
   addAwesomeMarkers(icon = icon.b, lat = GC_osm$lat, lng = GC_osm$lon, popup = "<strong>Geocode via OSM</strong>") %>% 
   addAwesomeMarkers(icon = icon.r, lat = 36.0544 , lng = -112.1401, popup = "<strong>Google search</strong>")
```

In addition to returning coordinates, `geocode` can return simple feature (sf) points containing the attributes from the geocoding call:

```{r}
sw = AOI::geocode("stearns wharf", pt = T)

str(sw$pt, max.level = 2)

```

```{r}
kabble(names(sw$pt))
sw$pt$display_name
```

```{r, message=F, warning=F}

leaflet() %>% addTiles() %>% addMarkers(data = pt$pt)

```

The OSM geocoding functionality can also be used to derive bounding areas describing the entity being queried:

```{r, message = F}
GC = geocode("garden of the gods", bb = T)
```

```{r, echo = FALSE}
leaflet(option=leafletOptions(zoomControl= FALSE, minZoom = 12, maxZoom = 15)) %>% addTiles() %>% 
   addPolygons(data = GC$bb, fillColor = "transparent", color = 'red', weight = 6, opacity = 1) 
```

##Multiple Points

Geocode can also be used to query multiple points

```{r}
geocode(c("UCSB", "Goleta"))
```

```{r message = F}
pt = geocode(c("UCSB", "Goleta", "stearns wharf"), pt = T)
leaflet() %>% addTiles() %>% addMarkers(data = pt$pt, popup = pt$pt$location)

```

```{r message = F}
x = geocode(c("UCSB", "Goleta", "stearns wharf"), pt = T, bb = T)
leaflet() %>% addTiles() %>% addMarkers(data = x$pt, popup = x$pt$location) %>% addPolygons(data = x$bb, fillColor = 'transparent', color = 'red')

```

##*Reverse Geocoding example*:

Reverse geocoding is from latitude and longitude to placename(s). Depending on the specificity of the placname requested a varying number of attributes can be used to describe the locaton. AOIs `revgeocode` provides an interface the the OSM and ESRI revgeocing services to provide a joined list of descriptors. For example, we can learn more about the location lat:38:lon:-104.

```{r}
revgeocode(c(38,-104))
```


Since it is often nice to have such a detailed description of a location the above geocoding function is baked into the revgeocode function allowing for 'psuedo' reverse geocoding:

```{r}
rc = revgeocode("UCSB")
print(rc)
```

All values returned by a `revgeocode` call can be isolates with the `$` operator:

```{r}
rc$match_addr
```

The bounding box parameter can be used as input as to 'bbox_sp' to generated a spatial geometry for the region.

```{r}
str(bbox_sp(rc$bb), max.level = 2)
```

Notice however that this differes from the straight geocoding option 

```{r}

gcUCSB = geocode("UCSB", bb = T)

str(gcUCSB$bb, max.level = 2)

```

```{r}
leaflet(option=leafletOptions(zoomControl= FALSE, minZoom = 13, maxZoom = 13)) %>% addProviderTiles(providers$CartoDB.Positron) %>% 
addPolygons(data = bbox_sp(rc$bb),fillColor = "transparent", color = col, weight = 4, label = "revgeocode") %>% 
addPolygons(data = gcUCSB$bb, fillColor = "transparent", color = 'red', weight = 4, label = "geocode")

```

## Geocoding Events, entities, and ideas:

So far we have explored services that allow for the forward and reverse geocoding of entities that are generally found in gazetters (DEFINE). Many times, espessially in social sciences like history, architecture, or archiology, there is a need to link events with space. For these purposed `AOI` provides a geooding wrapper that capitilizes on the open wikipedia database.

1. Looks for expicit coordinate entries
2. Looks for locations in the entry info box
3. Searches for alternative pages (linked entries)
4. Searches for Locations on the Alternative Pages
5. Searches for mentions of Headquarters
6. Fails gracefully

```{r}
mlk_speech = geocode_wiki("I have a dream speech")
```

```{r}
mlk_speech = geocode_wiki("NOAA")
```

```{r}
mlk_speech = geocode_wiki("Hurricane Harvey")
```





Here we see that while being able to extarcting bounding box information (eg AOI information) from geocoding processes there is a ceratin level of variability in these returned based on the nature of the call an the service reporting. As such the AOI pakcage offers a number of methods for more explicitly defining an AOI based on state, county and clip boundaries. 
